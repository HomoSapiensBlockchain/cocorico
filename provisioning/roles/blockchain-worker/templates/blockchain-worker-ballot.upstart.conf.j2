description "{{ project_name }}-{{ role_name }}-ballot"

start on started {{ project_name }}-{{ role_name }}
stop on stopped {{ project_name }}-{{ role_name }}

expect fork
respawn

env PM2_HOME=/root/.pm2
env NODE_PATH=/usr/lib/node_modules
env NODE_ENV={{ environment_name }}
{% if is_development_environment %}
env NODE_TLS_REJECT_UNAUTHORIZED=0
{% endif %}

setuid root
setgid root
chdir "{{ cocorico_local_dir }}/blockchain-worker"

pre-start script
    npm run build-ballot
end script

script
    exec pm2 \
        start \
        ./dist/ballot/index.js \
        --log {{ log_dir }}/{{ role_name }}-ballot.log \
        --merge-logs \
        --name "{{ role_name }}-ballot"
end script

post-start script
    PID=`pm2 jlist | jq '.[] | select(.name == "{{ role_name }}-ballot") | .pid'`
    echo $PID > /var/run/{{ project_name }}-{{ role_name }}-ballot.pid
end script

post-stop script
    exec pm2 stop "{{ role_name }}-ballot"
    rm -f /var/run/{{ project_name }}-{{ role_name }}-ballot.pid
end script
