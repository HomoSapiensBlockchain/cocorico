'use strict';

var config = require('/opt/cocorico/api-web/config.json');

var keystone = require('keystone');
var transform = require('model-transform');
var metafetch = require('metafetch');
var async = require('async');
var Web3 = require('web3');

var Types = keystone.Field.Types;

var Vote = new keystone.List('Vote', {
  autokey: { path: 'slug', from: 'title', unique: true },
  // map: { name: 'title' },
  track: { createdAt: true, updatedAt: true },
  sortable: true,
  noedit: config.env !== 'development',
  nocreate: config.env !== 'development',
  nodelete: config.env !== 'development'
});

Vote.add({
  app: { type: Types.Relationship, ref: 'App', initial: true },
  url: { type: Types.Url, initial: true },
  title: { type: Types.Text },
  description: { type: Types.Textarea },
  image: { type: Types.Url },
  status: {
    type: Types.Select,
    options: ['initializing', 'open', 'complete', 'error']
  },
  voteContractAddress: { type: Types.Text, noedit: true },
  voteContractABI: { type: Types.Text, noedit: true },
  restricted: { type: Types.Boolean, default: false },
  labels: { type: Types.TextArray }
});

Vote.relationship({ path: 'sources', ref: 'Source', refPath: 'vote' });

Vote.schema.methods.userIsAuthorizedToVote = function (user) {
  return config.capabilities.vote.enabled && this.status === 'open' && !!this.voteContractAddress && !!this.voteContractABI && !!user && (!this.restricted || !!user.iss && user.iss === this.app) && (!user.authorizedVotes || !user.authorizedVotes.length || user.authorizedVotes.indexOf(this.id) >= 0);
};

function completeVote(vote, next) {
  if (!vote.voteContractAddress) {
    next(null);
  }

  var web3 = new Web3();
  web3.setProvider(new web3.providers.HttpProvider('http://127.0.0.1:8545'));

  async.waterfall([function (callback) {
    return web3.eth.getAccounts(callback);
  }, function (accounts, callback) {
    return web3.eth.contract(JSON.parse(vote.voteContractABI)).at(vote.voteContractAddress, function (err, instance) {
      return callback(err, accounts, instance);
    });
  }, function (accounts, instance, callback) {
    return instance.end.sendTransaction({ from: accounts[0] }, function (err, txhash) {
      callback(err, txhash);
    });
  }], function (err, txhash) {
    next(err);
  });
}

function pushVoteOnQueue(vote, callback) {
  require('amqplib/callback_api').connect('amqp://localhost', function (err, conn) {
    if (err != null) return callback(err, null);

    return conn.createChannel(function (channelErr, ch) {
      if (channelErr != null) return callback(channelErr, null);

      var voteMsg = { vote: { id: vote.id } };

      ch.assertQueue('votes');
      ch.sendToQueue('votes', new Buffer(JSON.stringify(voteMsg)), { persistent: true });

      return callback(null, voteMsg);
    });
  });
}

Vote.schema.pre('validate', function (next) {
  var self = this;

  if (!self.url) {
    return next();
  }

  if (self.isModified('status') && self.status === 'complete') {
    return completeVote(self, next);
  }

  return async.waterfall([function (callback) {
    return !metafetch.fetch(self.url, {
      flags: { images: false, links: false },
      http: { timeout: 30000 }
    }, function (err, meta) {
      self.title = meta.title;
      self.description = meta.description;
      self.image = meta.image;

      callback(null);
    });
  }, function (callback) {
    if (!self.status) {
      self.status = 'initializing';
      pushVoteOnQueue(self, function (err, msg) {
        return callback(err);
      });
    } else {
      callback(null);
    }
  }], function (err) {
    next(err);
  });
});

transform.toJSON(Vote);

Vote.defaultColumns = 'title, url, status, voteContractAddress';
Vote.register();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tb2RlbHMvVm90ZS5qcyJdLCJuYW1lcyI6WyJjb25maWciLCJyZXF1aXJlIiwia2V5c3RvbmUiLCJ0cmFuc2Zvcm0iLCJtZXRhZmV0Y2giLCJhc3luYyIsIldlYjMiLCJUeXBlcyIsIkZpZWxkIiwiVm90ZSIsIkxpc3QiLCJhdXRva2V5IiwicGF0aCIsImZyb20iLCJ1bmlxdWUiLCJ0cmFjayIsImNyZWF0ZWRBdCIsInVwZGF0ZWRBdCIsInNvcnRhYmxlIiwibm9lZGl0IiwiZW52Iiwibm9jcmVhdGUiLCJub2RlbGV0ZSIsImFkZCIsImFwcCIsInR5cGUiLCJSZWxhdGlvbnNoaXAiLCJyZWYiLCJpbml0aWFsIiwidXJsIiwiVXJsIiwidGl0bGUiLCJUZXh0IiwiZGVzY3JpcHRpb24iLCJUZXh0YXJlYSIsImltYWdlIiwic3RhdHVzIiwiU2VsZWN0Iiwib3B0aW9ucyIsInZvdGVDb250cmFjdEFkZHJlc3MiLCJ2b3RlQ29udHJhY3RBQkkiLCJyZXN0cmljdGVkIiwiQm9vbGVhbiIsImRlZmF1bHQiLCJsYWJlbHMiLCJUZXh0QXJyYXkiLCJyZWxhdGlvbnNoaXAiLCJyZWZQYXRoIiwic2NoZW1hIiwibWV0aG9kcyIsInVzZXJJc0F1dGhvcml6ZWRUb1ZvdGUiLCJ1c2VyIiwiY2FwYWJpbGl0aWVzIiwidm90ZSIsImVuYWJsZWQiLCJpc3MiLCJhdXRob3JpemVkVm90ZXMiLCJsZW5ndGgiLCJpbmRleE9mIiwiaWQiLCJjb21wbGV0ZVZvdGUiLCJuZXh0Iiwid2ViMyIsInNldFByb3ZpZGVyIiwicHJvdmlkZXJzIiwiSHR0cFByb3ZpZGVyIiwid2F0ZXJmYWxsIiwiY2FsbGJhY2siLCJldGgiLCJnZXRBY2NvdW50cyIsImFjY291bnRzIiwiY29udHJhY3QiLCJKU09OIiwicGFyc2UiLCJhdCIsImVyciIsImluc3RhbmNlIiwiZW5kIiwic2VuZFRyYW5zYWN0aW9uIiwidHhoYXNoIiwicHVzaFZvdGVPblF1ZXVlIiwiY29ubmVjdCIsImNvbm4iLCJjcmVhdGVDaGFubmVsIiwiY2hhbm5lbEVyciIsImNoIiwidm90ZU1zZyIsImFzc2VydFF1ZXVlIiwic2VuZFRvUXVldWUiLCJCdWZmZXIiLCJzdHJpbmdpZnkiLCJwZXJzaXN0ZW50IiwicHJlIiwic2VsZiIsImlzTW9kaWZpZWQiLCJmZXRjaCIsImZsYWdzIiwiaW1hZ2VzIiwibGlua3MiLCJodHRwIiwidGltZW91dCIsIm1ldGEiLCJtc2ciLCJ0b0pTT04iLCJkZWZhdWx0Q29sdW1ucyIsInJlZ2lzdGVyIl0sIm1hcHBpbmdzIjoiOztBQUFBLElBQUlBLFNBQVNDLFFBQVEsbUNBQVIsQ0FBYjs7QUFFQSxJQUFJQyxXQUFXRCxRQUFRLFVBQVIsQ0FBZjtBQUNBLElBQUlFLFlBQVlGLFFBQVEsaUJBQVIsQ0FBaEI7QUFDQSxJQUFJRyxZQUFZSCxRQUFRLFdBQVIsQ0FBaEI7QUFDQSxJQUFJSSxRQUFRSixRQUFRLE9BQVIsQ0FBWjtBQUNBLElBQUlLLE9BQU9MLFFBQVEsTUFBUixDQUFYOztBQUVBLElBQUlNLFFBQVFMLFNBQVNNLEtBQVQsQ0FBZUQsS0FBM0I7O0FBRUEsSUFBSUUsT0FBTyxJQUFJUCxTQUFTUSxJQUFiLENBQWtCLE1BQWxCLEVBQTBCO0FBQ25DQyxXQUFTLEVBQUVDLE1BQU0sTUFBUixFQUFnQkMsTUFBTSxPQUF0QixFQUErQkMsUUFBUSxJQUF2QyxFQUQwQjtBQUVuQztBQUNBQyxTQUFPLEVBQUVDLFdBQVcsSUFBYixFQUFtQkMsV0FBVyxJQUE5QixFQUg0QjtBQUluQ0MsWUFBVSxJQUp5QjtBQUtuQ0MsVUFBUW5CLE9BQU9vQixHQUFQLEtBQWUsYUFMWTtBQU1uQ0MsWUFBVXJCLE9BQU9vQixHQUFQLEtBQWUsYUFOVTtBQU9uQ0UsWUFBVXRCLE9BQU9vQixHQUFQLEtBQWU7QUFQVSxDQUExQixDQUFYOztBQVVBWCxLQUFLYyxHQUFMLENBQVM7QUFDUEMsT0FBSyxFQUFFQyxNQUFNbEIsTUFBTW1CLFlBQWQsRUFBNEJDLEtBQUssS0FBakMsRUFBd0NDLFNBQVMsSUFBakQsRUFE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LEVBQW1CaEMsSUFBbkIsQ0FBUDtBQUNEOztBQUVELFNBQU94RCxNQUFNNkQsU0FBTixDQUNMLENBQ0UsVUFBQ0MsUUFBRDtBQUFBLFdBQWMsQ0FBQy9ELFVBQVUyRixLQUFWLENBQ2JGLEtBQUtoRSxHQURRLEVBRWI7QUFDRW1FLGFBQU8sRUFBRUMsUUFBUSxLQUFWLEVBQWlCQyxPQUFPLEtBQXhCLEVBRFQ7QUFFRUMsWUFBTSxFQUFFQyxTQUFTLEtBQVg7QUFGUixLQUZhLEVBTWIsVUFBQ3pCLEdBQUQsRUFBTTBCLElBQU4sRUFBZTtBQUNiUixXQUFLOUQsS0FBTCxHQUFhc0UsS0FBS3RFLEtBQWxCO0FBQ0E4RCxXQUFLNUQsV0FBTCxHQUFtQm9FLEtBQUtwRSxXQUF4QjtBQUNBNEQsV0FBSzFELEtBQUwsR0FBYWtFLEtBQUtsRSxLQUFsQjs7QUFFQWdDLGVBQVMsSUFBVDtBQUNELEtBWlksQ0FBZjtBQUFBLEdBREYsRUFlRSxVQUFDQSxRQUFELEVBQWM7QUFDWixRQUFJLENBQUMwQixLQUFLekQsTUFBVixFQUFrQjtBQUNoQnlELFdBQUt6RCxNQUFMLEdBQWMsY0FBZDtBQUNBNEMsc0JBQWdCYSxJQUFoQixFQUFzQixVQUFDbEIsR0FBRCxFQUFNMkIsR0FBTjtBQUFBLGVBQWNuQyxTQUFTUSxHQUFULENBQWQ7QUFBQSxPQUF0QjtBQUNELEtBSEQsTUFHTztBQUNMUixlQUFTLElBQVQ7QUFDRDtBQUNGLEdBdEJILENBREssRUF5QkwsVUFBQ1EsR0FBRCxFQUFTO0FBQ1BkLFNBQUtjLEdBQUw7QUFDRCxHQTNCSSxDQUFQO0FBNkJELENBeENEOztBQTBDQXhFLFVBQVVvRyxNQUFWLENBQWlCOUYsSUFBakI7O0FBRUFBLEtBQUsrRixjQUFMLEdBQXNCLHlDQUF0QjtBQUNBL0YsS0FBS2dHLFFBQUwiLCJmaWxlIjoiVm90ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBjb25maWcgPSByZXF1aXJlKCcvb3B0L2NvY29yaWNvL2FwaS13ZWIvY29uZmlnLmpzb24nKTtcblxudmFyIGtleXN0b25lID0gcmVxdWlyZSgna2V5c3RvbmUnKTtcbnZhciB0cmFuc2Zvcm0gPSByZXF1aXJlKCdtb2RlbC10cmFuc2Zvcm0nKTtcbnZhciBtZXRhZmV0Y2ggPSByZXF1aXJlKCdtZXRhZmV0Y2gnKTtcbnZhciBhc3luYyA9IHJlcXVpcmUoJ2FzeW5jJyk7XG52YXIgV2ViMyA9IHJlcXVpcmUoJ3dlYjMnKTtcblxudmFyIFR5cGVzID0ga2V5c3RvbmUuRmllbGQuVHlwZXM7XG5cbnZhciBWb3RlID0gbmV3IGtleXN0b25lLkxpc3QoJ1ZvdGUnLCB7XG4gIGF1dG9rZXk6IHsgcGF0aDogJ3NsdWcnLCBmcm9tOiAndGl0bGUnLCB1bmlxdWU6IHRydWUgfSxcbiAgLy8gbWFwOiB7IG5hbWU6ICd0aXRsZScgfSxcbiAgdHJhY2s6IHsgY3JlYXRlZEF0OiB0cnVlLCB1cGRhdGVkQXQ6IHRydWUgfSxcbiAgc29ydGFibGU6IHRydWUsXG4gIG5vZWRpdDogY29uZmlnLmVudiAhPT0gJ2RldmVsb3BtZW50JyxcbiAgbm9jcmVhdGU6IGNvbmZpZy5lbnYgIT09ICdkZXZlbG9wbWVudCcsXG4gIG5vZGVsZXRlOiBjb25maWcuZW52ICE9PSAnZGV2ZWxvcG1lbnQnLFxufSk7XG5cblZvdGUuYWRkKHtcbiAgYXBwOiB7IHR5cGU6IFR5cGVzLlJlbGF0aW9uc2hpcCwgcmVmOiAnQXBwJywgaW5pdGlhbDogdHJ1ZSB9LFxuICB1cmw6IHsgdHlwZTogVHlwZXMuVXJsLCBpbml0aWFsOiB0cnVlIH0sXG4gIHRpdGxlOiB7IHR5cGU6IFR5cGVzLlRleHQgfSxcbiAgZGVzY3JpcHRpb246IHsgdHlwZTogVHlwZXMuVGV4dGFyZWEgfSxcbiAgaW1hZ2U6IHsgdHlwZTogVHlwZXMuVXJsIH0sXG4gIHN0YXR1czoge1xuICAgIHR5cGU6IFR5cGVzLlNlbGVjdCxcbiAgICBvcHRpb25zOiBbJ2luaXRpYWxpemluZycsICdvcGVuJywgJ2NvbXBsZXRlJywgJ2Vycm9yJ10sXG4gIH0sXG4gIHZvdGVDb250cmFjdEFkZHJlc3M6IHsgdHlwZTogVHlwZXMuVGV4dCwgbm9lZGl0OiB0cnVlIH0sXG4gIHZvdGVDb250cmFjdEFCSTogeyB0eXBlOiBUeXBlcy5UZXh0LCBub2VkaXQ6IHRydWUgfSxcbiAgcmVzdHJpY3RlZDogeyB0eXBlOiBUeXBlcy5Cb29sZWFuLCBkZWZhdWx0OiBmYWxzZSB9LFxuICBsYWJlbHM6IHsgdHlwZTogVHlwZXMuVGV4dEFycmF5IH0sXG59KTtcblxuVm90ZS5yZWxhdGlvbnNoaXAoeyBwYXRoOiAnc291cmNlcycsIHJlZjogJ1NvdXJjZScsIHJlZlBhdGg6ICd2b3RlJyB9KTtcblxuVm90ZS5zY2hlbWEubWV0aG9kcy51c2VySXNBdXRob3JpemVkVG9Wb3RlID0gZnVuY3Rpb24odXNlcikge1xuICByZXR1cm4gY29uZmlnLmNhcGFiaWxpdGllcy52b3RlLmVuYWJsZWRcbiAgICAmJiB0aGlzLnN0YXR1cyA9PT0gJ29wZW4nXG4gICAgJiYgISF0aGlzLnZvdGVDb250cmFjdEFkZHJlc3NcbiAgICAmJiAhIXRoaXMudm90ZUNvbnRyYWN0QUJJXG4gICAgJiYgISF1c2VyXG4gICAgJiYgKCF0aGlzLnJlc3RyaWN0ZWQgfHwgKCEhdXNlci5pc3MgJiYgdXNlci5pc3MgPT09IHRoaXMuYXBwKSlcbiAgICAmJiAoIXVzZXIuYXV0aG9yaXplZFZvdGVzXG4gICAgICB8fCAhdXNlci5hdXRob3JpemVkVm90ZXMubGVuZ3RoXG4gICAgICB8fCB1c2VyLmF1dGhvcml6ZWRWb3Rlcy5pbmRleE9mKHRoaXMuaWQpID49IDApO1xufVxuXG5mdW5jdGlvbiBjb21wbGV0ZVZvdGUodm90ZSwgbmV4dCkge1xuICBpZiAoIXZvdGUudm90ZUNvbnRyYWN0QWRkcmVzcykge1xuICAgIG5leHQobnVsbCk7XG4gIH1cblxuICB2YXIgd2ViMyA9IG5ldyBXZWIzKCk7XG4gIHdlYjMuc2V0UHJvdmlkZXIobmV3IHdlYjMucHJvdmlkZXJzLkh0dHBQcm92aWRlcihcbiAgICAnaHR0cDovLzEyNy4wLjAuMTo4NTQ1J1xuICApKTtcblxuICBhc3luYy53YXRlcmZhbGwoXG4gICAgW1xuICAgICAgKGNhbGxiYWNrKSA9PiB3ZWIzLmV0aC5nZXRBY2NvdW50cyhjYWxsYmFjayksXG4gICAgICAoYWNjb3VudHMsIGNhbGxiYWNrKSA9PiB3ZWIzLmV0aC5jb250cmFjdChcbiAgICAgICAgSlNPTi5wYXJzZSh2b3RlLnZvdGVDb250cmFjdEFCSSlcbiAgICAgIClcbiAgICAgIC5hdChcbiAgICAgICAgdm90ZS52b3RlQ29udHJhY3RBZGRyZXNzLFxuICAgICAgICAoZXJyLCBpbnN0YW5jZSkgPT4gY2FsbGJhY2soZXJyLCBhY2NvdW50cywgaW5zdGFuY2UpXG4gICAgICApLFxuICAgICAgKGFjY291bnRzLCBpbnN0YW5jZSwgY2FsbGJhY2spID0+IGluc3RhbmNlLmVuZFxuICAgICAgICAuc2VuZFRyYW5zYWN0aW9uKHtmcm9tOiBhY2NvdW50c1swXX0sIChlcnIsIHR4aGFzaCkgPT4ge1xuICAgICAgICAgIGNhbGxiYWNrKGVyciwgdHhoYXNoKTtcbiAgICAgICAgfSksXG4gICAgXSxcbiAgICAoZXJyLCB0eGhhc2gpID0+IHtcbiAgICAgIG5leHQoZXJyKTtcbiAgICB9XG4gICk7XG59XG5cbmZ1bmN0aW9uIHB1c2hWb3RlT25RdWV1ZSh2b3RlLCBjYWxsYmFjaykge1xuICByZXF1aXJlKCdhbXFwbGliL2NhbGxiYWNrX2FwaScpLmNvbm5lY3QoXG4gICAgJ2FtcXA6Ly9sb2NhbGhvc3QnLFxuICAgIChlcnIsIGNvbm4pID0+IHtcbiAgICAgIGlmIChlcnIgIT0gbnVsbClcbiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVyciwgbnVsbCk7XG5cbiAgICAgIHJldHVybiBjb25uLmNyZWF0ZUNoYW5uZWwoKGNoYW5uZWxFcnIsIGNoKSA9PiB7XG4gICAgICAgIGlmIChjaGFubmVsRXJyICE9IG51bGwpXG4gICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGNoYW5uZWxFcnIsIG51bGwpO1xuXG4gICAgICAgIHZhciB2b3RlTXNnID0geyB2b3RlIDogeyBpZCA6IHZvdGUuaWQgfSB9O1xuXG4gICAgICAgIGNoLmFzc2VydFF1ZXVlKCd2b3RlcycpO1xuICAgICAgICBjaC5zZW5kVG9RdWV1ZShcbiAgICAgICAgICAndm90ZXMnLFxuICAgICAgICAgIG5ldyBCdWZmZXIoSlNPTi5zdHJpbmdpZnkodm90ZU1zZykpLFxuICAgICAgICAgIHsgcGVyc2lzdGVudCA6IHRydWUgfVxuICAgICAgICApO1xuXG4gICAgICAgIHJldHVybiBjYWxsYmFjayhudWxsLCB2b3RlTXNnKTtcbiAgICAgIH0pO1xuICAgIH1cblx0KTtcbn1cblxuVm90ZS5zY2hlbWEucHJlKCd2YWxpZGF0ZScsIGZ1bmN0aW9uKG5leHQpIHtcbiAgdmFyIHNlbGYgPSB0aGlzO1xuXG4gIGlmICghc2VsZi51cmwpIHtcbiAgICByZXR1cm4gbmV4dCgpO1xuICB9XG5cbiAgaWYgKHNlbGYuaXNNb2RpZmllZCgnc3RhdHVzJykgJiYgc2VsZi5zdGF0dXMgPT09ICdjb21wbGV0ZScpIHtcbiAgICByZXR1cm4gY29tcGxldGVWb3RlKHNlbGYsIG5leHQpO1xuICB9XG5cbiAgcmV0dXJuIGFzeW5jLndhdGVyZmFsbChcbiAgICBbXG4gICAgICAoY2FsbGJhY2spID0+ICFtZXRhZmV0Y2guZmV0Y2goXG4gICAgICAgIHNlbGYudXJsLFxuICAgICAgICB7XG4gICAgICAgICAgZmxhZ3M6IHsgaW1hZ2VzOiBmYWxzZSwgbGlua3M6IGZhbHNlIH0sXG4gICAgICAgICAgaHR0cDogeyB0aW1lb3V0OiAzMDAwMCB9LFxuICAgICAgICB9LFxuICAgICAgICAoZXJyLCBtZXRhKSA9PiB7XG4gICAgICAgICAgc2VsZi50aXRsZSA9IG1ldGEudGl0bGU7XG4gICAgICAgICAgc2VsZi5kZXNjcmlwdGlvbiA9IG1ldGEuZGVzY3JpcHRpb247XG4gICAgICAgICAgc2VsZi5pbWFnZSA9IG1ldGEuaW1hZ2U7XG5cbiAgICAgICAgICBjYWxsYmFjayhudWxsKTtcbiAgICAgICAgfVxuICAgICAgKSxcbiAgICAgIChjYWxsYmFjaykgPT4ge1xuICAgICAgICBpZiAoIXNlbGYuc3RhdHVzKSB7XG4gICAgICAgICAgc2VsZi5zdGF0dXMgPSAnaW5pdGlhbGl6aW5nJztcbiAgICAgICAgICBwdXNoVm90ZU9uUXVldWUoc2VsZiwgKGVyciwgbXNnKSA9PiBjYWxsYmFjayhlcnIpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjYWxsYmFjayhudWxsKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICBdLFxuICAgIChlcnIpID0+IHtcbiAgICAgIG5leHQoZXJyKTtcbiAgICB9XG4gICk7XG59KTtcblxudHJhbnNmb3JtLnRvSlNPTihWb3RlKTtcblxuVm90ZS5kZWZhdWx0Q29sdW1ucyA9ICd0aXRsZSwgdXJsLCBzdGF0dXMsIHZvdGVDb250cmFjdEFkZHJlc3MnO1xuVm90ZS5yZWdpc3RlcigpO1xuIl19